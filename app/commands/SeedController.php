<?php

namespace app\commands;

use yii\console\Controller;
use yii\helpers\Console;
use Yii;
use yii\db\Expression;

class SeedController extends Controller
{
    /**
     * Заполняет таблицы authors и books тестовыми данными
     */
    public function actionRun()
    {
        $db = Yii::$app->db;

        $this->stdout("Очистка таблиц...\n", Console::FG_YELLOW);
        $db->createCommand()->delete('books')->execute();
        $db->createCommand()->delete('authors')->execute();

        $this->stdout("Вставка авторов...\n", Console::FG_GREEN);
        $db->createCommand()->batchInsert('authors', ['id', 'name', 'birth_year', 'country'], [
            [1, 'Лев Толстой', 1828, 'Россия'],
            [2, 'Фёдор Достоевский', 1821, 'Россия'],
            [3, 'Эрнест Хемингуэй', 1899, 'США'],
            [4, 'Джордж Оруэлл', 1903, 'Великобритания'],
            [5, 'Агата Кристи', 1890, 'Великобритания'],
            [6, 'Габриэль Гарсиа Маркес', 1927, 'Колумбия'],
            [7, 'Джоан Роулинг', 1965, 'Великобритания'],
            [8, 'Харпер Ли', 1926, 'США'],
            [9, 'Фрэнсис Скотт Фицджеральд', 1896, 'США'],
            [10, 'Джейн Остин', 1775, 'Великобритания'],
        ])->execute();

        $this->stdout("Вставка книг...\n", Console::FG_GREEN);
        $db->createCommand()->batchInsert('books', ['id', 'title', 'author_id', 'pages', 'language', 'genre', 'description'], [
            [1, 'Война и мир', 1, 1225, 'русский', 'роман-эпопея', 'Эпическое произведение о войне 1812 года'],
            [2, 'Анна Каренина', 1, 864, 'русский', 'роман', 'История любви замужней женщины'],
            [3, 'Преступление и наказание', 2, 672, 'русский', 'психологический роман', 'История бывшего студента, совершившего убийство'],
            [4, 'Братья Карамазовы', 2, 840, 'русский', 'философский роман', 'Последний роман Достоевского'],
            [5, 'Старик и море', 3, 128, 'английский', 'повесть', 'История старика-рыбака и его борьбы с большой рыбой'],
            [6, '1984', 4, 328, 'английский', 'антиутопия', 'Роман о тоталитарном обществе'],
            [7, 'Скотный двор', 4, 112, 'английский', 'сатира', 'Аллегория на революцию 1917 года'],
            [8, 'Убийство в Восточном экспрессе', 5, 256, 'английский', 'детектив', 'Одно из самых известных произведений Эркюля Пуаро'],
            [9, 'Сто лет одиночества', 6, 416, 'испанский', 'магический реализм', 'История семьи Буэндиа'],
            [10, 'Гарри Поттер и философский камень', 7, 320, 'английский', 'фэнтези', 'Первая книга о юном волшебнике'],
            [11, 'Убить пересмешника', 8, 281, 'английский', 'роман воспитания', 'История расовой несправедливости на Юге США'],
            [12, 'Великий Гэтсби', 9, 180, 'английский', 'роман', 'История загадочного миллионера'],
            [13, 'Гордость и предубеждение', 10, 279, 'английский', 'роман', 'История любви Элизабет Беннет и мистера Дарси'],
            [14, 'Воскресение', 1, 528, 'русский', 'роман', 'Последний роман Толстого'],
            [15, 'Идиот', 2, 640, 'русский', 'роман', 'История князя Мышкина'],
        ])->execute();

        $this->stdout("Сброс последовательностей...\n", Console::FG_CYAN);
        $db->createCommand("SELECT setval(pg_get_serial_sequence('authors', 'id'), (SELECT MAX(id) FROM authors));")->execute();
        $db->createCommand("SELECT setval(pg_get_serial_sequence('books', 'id'), (SELECT MAX(id) FROM books));")->execute();

        $this->stdout("Сиды успешно применены\n", Console::FG_BLUE);
    }
}
